<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Signature scanning</title>
<meta name="author" content="8dcc" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">Signature scanning</h1>
<p>
<a href="../index.html">Index</a> | <a href="index.html">Up</a>
</p>

<hr />

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3cbd4c2">1. What is signature scanning?</a></li>
<li><a href="#orga56cace">2. Finding the function inside the binary</a></li>
<li><a href="#org0813bb8">3. Getting the signature</a></li>
<li><a href="#org478ffa9">4. Signature scanning function</a>
<ul>
<li><a href="#orgdf15638">4.1. Parsing the IDA pattern string</a></li>
<li><a href="#org0aa7a23">4.2. <code>sigscan</code> function</a></li>
<li><a href="#org795547a">4.3. Getting the bounds of a loaded module</a></li>
</ul>
</li>
<li><a href="#org5567c6f">5. Using our <code>find_sig</code> function</a></li>
<li><a href="#org4803303">6. Injecting script and final Makefile</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3cbd4c2" class="outline-2">
<h2 id="org3cbd4c2"><span class="section-number-2">1.</span> What is signature scanning?</h2>
<div class="outline-text-2" id="text-1">
<p>
First, let's have a look at a sample program:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdio.h&gt;</span>

<span style="color: #ff6f9f;">static</span> <span style="color: #79a8ff;">int</span> <span style="color: #4ae2ff;">my_func</span>(<span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">x</span>, <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">y</span>) {
    <span style="color: #ff6f9f;">if</span> (y &gt; x || y &lt; <span style="color: #88ca9f;">0</span> || y &gt; <span style="color: #88ca9f;">32</span>)
        <span style="color: #ff6f9f;">return</span> <span style="color: #88ca9f;">0</span>;

    puts(<span style="color: #00d3d0;">"Hello from my_func!"</span>);

    <span style="color: #ff6f9f;">return</span> (x &gt;&gt; y) * <span style="color: #88ca9f;">3</span>;
}

<span style="color: #79a8ff;">int</span> <span style="color: #4ae2ff;">main</span>(<span style="color: #79a8ff;">void</span>) {
    <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">x</span> = <span style="color: #88ca9f;">0x100</span>;
    <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">y</span> = <span style="color: #88ca9f;">4</span>;
    printf(<span style="color: #00d3d0;">"%d\n"</span>, my_func(x, y));

    <span style="color: #989898;">/* </span><span style="color: #989898;">Infinite loop for injecting later</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">for</span> (;;)
        ;

    <span style="color: #ff6f9f;">return</span> <span style="color: #88ca9f;">0</span>;
}
</pre>
</div>

<p>
Imagine we are, for example, injecting a <code>.dll</code> or <code>.so</code> into a process, and we want
to find a function or a value at runtime. A valid approach would be to scan the
memory of the loaded binary, and search for the bytes corresponding to the
function or variable. Then, depending on what we are actually looking for, we
could read the information, call the function, or even overwrite the bytes
directly from memory (after changing the necessary permissions, of course).
</p>

<p>
In our case, we would want to look for the bytes of the binary corresponding to
<code>my_func</code>.
</p>
</div>
</div>

<div id="outline-container-orga56cace" class="outline-2">
<h2 id="orga56cace"><span class="section-number-2">2.</span> Finding the function inside the binary</h2>
<div class="outline-text-2" id="text-2">
<p>
I will compile the previous source with <code>gcc 13.2.1</code>. We need to use <code>-O0</code> so the
function call doesn't get optimized. I also used <code>strip</code> to "simulate" a real
world scenario where we can't just look at the symbols.
</p>

<pre class="example">
gcc -Wall -Wextra -O0 -o example.out example.c
strip example.out
</pre>

<p>
Let's have a look at the generated binary using <a href="https://cutter.re/">cutter</a>, in my case version
2.3.1. First, we need to change some settings. Go to <code>Edit &gt; Preferences</code> and make
sure the following settings are enabled in the disassembly tab:
</p>

<ul class="org-ul">
<li><i>Display the bytes of each instruction:</i> Enabled</li>
<li><i>Number of bytes of each instruction:</i> 8</li>
<li><i>Align bytes to the left:</i> Enabled</li>
<li><i>Separate bytes with whitespace:</i> Enabled</li>
</ul>

<p>
You can change the rest of the settings to match your taste. Note that you could
also be using <a href="https://rizin.re/">rizin</a> for all the following steps, the backend and CLI version of
cutter. All the mentioned settings can be changed in rizin by using the name in
parentheses in the cutter menu.
</p>

<p>
Now that we configured cutter, we can see the assembly bytes of each
instruction. These are the bytes that we will be using for our signature, but
first, we need to find what we are looking for from cutter.
</p>

<p>
This is the disassembly of the main function:
</p>


<div id="org0a2530b" class="figure">
<p><img src="../img/signature-scanning1.png" alt="signature-scanning1.png" />
</p>
</div>

<p>
As you can see, in <code>main+0x8</code> we are loading <code>0x100</code> and <code>4</code> into the local
variables, and in <code>main+0x1c</code> we are loading them into the registers used for
function parameters according to the AMD64 System V ABI. In <code>main+0x20</code>, we are
calling <code>my_func</code>. Let's double-click it to have a look at the assembly:
</p>


<div id="org498e273" class="figure">
<p><img src="../img/signature-scanning2.png" alt="signature-scanning2.png" />
</p>
</div>

<p>
Yeah, that looks like our function.
</p>
</div>
</div>

<div id="outline-container-org0813bb8" class="outline-2">
<h2 id="org0813bb8"><span class="section-number-2">3.</span> Getting the signature</h2>
<div class="outline-text-2" id="text-3">
<p>
The signature is going to be an arbitrary number of bytes from the target
function. However, some of the bytes will not be constant, so we need to have
that in mind.
</p>

<p>
For example, the last 4 bytes of <code>fcn.00001149+0x29</code> are not guaranteed to be
<code>8b 0e 00 00</code>. In our signature, we will have to use something like <code>? ? ? ?</code> to
identify it.
</p>

<p>
Some plugins like <a href="https://hex-rays.com/ida-pro/">IDA</a>'s <a href="https://github.com/ajkhoury/SigMaker-x64">sigmaker</a> are able to generate the signatures from a
selection. I decided to use cutter just to show that you only need a
disassembler.
</p>


<div id="org4b1537c" class="figure">
<p><img src="../img/signature-scanning3.png" alt="signature-scanning3.png" />
</p>
</div>

<p>
For our signature, we should use enough bytes to make sure they are unique for
the function/variable we are looking for. Here is a signature of the whole
function, but in practice, we shouldn't need more than 10 instructions.
</p>

<pre class="example" id="org04d2da6">
55 48 89 E5 48 83 EC 10 89 7D FC 89 75 F8 8B 45 F8 3B 45 FC 7F 0C 83 7D F8 00 78
06 83 7D F8 20 7E 07 B8 ? ? ? ? EB 1F 48 8D 05 ? ? ? ? 48 89 C7 E8 ? ? ? ? 8B 45
F8 8B 55 FC 89 C1 D3 FA 89 D0 01 C0 01 D0 C9 C3
</pre>

<p>
These kind of signature is usually called IDA format, but there are also code
signatures which contain the bytes directly in an array. To differentiate
between <code>'?'</code> and <code>0x3F</code>, these normally use an extra mask parameter to indicate
which bytes are unknown. IDA patterns are usually cleaner, but make the
signature scanning function a bit larger.
</p>
</div>
</div>

<div id="outline-container-org478ffa9" class="outline-2">
<h2 id="org478ffa9"><span class="section-number-2">4.</span> Signature scanning function</h2>
<div class="outline-text-2" id="text-4">
<p>
This is a simple function that scans a memory area from <code>start</code> to <code>end</code> and
searches for a <code>pattern</code> in IDA format.
</p>
</div>

<div id="outline-container-orgdf15638" class="outline-3">
<h3 id="orgdf15638"><span class="section-number-3">4.1.</span> Parsing the IDA pattern string</h3>
<div class="outline-text-3" id="text-4-1">
<p>
First, we would need a function to convert those <code>"E5 "</code> strings into <code>0xE5</code>. Here
it is:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdint.h&gt;</span>

<span style="color: #989898;">/* </span><span style="color: #989898;">"E0" -&gt; 224</span><span style="color: #989898;"> */</span>
<span style="color: #79a8ff;">uint8_t</span> <span style="color: #4ae2ff;">hex_to_byte</span>(<span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">hex</span>) {
    <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">ret</span> = <span style="color: #88ca9f;">0</span>;

    <span style="color: #989898;">/* </span><span style="color: #989898;">Skip leading spaces, if any</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">while</span> (*hex == <span style="color: #00d3d0;">' '</span>)
        hex++;

    <span style="color: #989898;">/* </span><span style="color: #989898;">Store a byte (two digits of string)</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">for</span> (<span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">i</span> = <span style="color: #88ca9f;">0</span>; i &lt; <span style="color: #88ca9f;">2</span> &amp;&amp; hex[i] != <span style="color: #00d3d0;">'\0'</span>; i++) {
        <span style="color: #79a8ff;">char</span> <span style="color: #6ae4b9;">c</span> = hex[i];

        <span style="color: #989898;">/* </span><span style="color: #989898;">For example "E ", although the format should always be "0E"</span><span style="color: #989898;"> */</span>
        <span style="color: #ff6f9f;">if</span> (c == <span style="color: #00d3d0;">' '</span>)
            <span style="color: #ff6f9f;">break</span>;

        <span style="color: #79a8ff;">uint8_t</span> <span style="color: #6ae4b9;">n</span> = <span style="color: #88ca9f;">0</span>;
        <span style="color: #ff6f9f;">if</span> (c &gt;= <span style="color: #00d3d0;">'0'</span> &amp;&amp; c &lt;= <span style="color: #00d3d0;">'9'</span>)
            n = c - <span style="color: #00d3d0;">'0'</span>;
        <span style="color: #ff6f9f;">else</span> <span style="color: #ff6f9f;">if</span> (c &gt;= <span style="color: #00d3d0;">'a'</span> &amp;&amp; c &lt;= <span style="color: #00d3d0;">'f'</span>)
            n = <span style="color: #88ca9f;">10</span> + c - <span style="color: #00d3d0;">'a'</span>;
        <span style="color: #ff6f9f;">else</span> <span style="color: #ff6f9f;">if</span> (c &gt;= <span style="color: #00d3d0;">'A'</span> &amp;&amp; c &lt;= <span style="color: #00d3d0;">'F'</span>)
            n = <span style="color: #88ca9f;">10</span> + c - <span style="color: #00d3d0;">'A'</span>;

        <span style="color: #989898;">/* </span><span style="color: #989898;">Shift size of 0xF and add the next half of byte</span><span style="color: #989898;"> */</span>
        ret &lt;&lt;= <span style="color: #88ca9f;">4</span>;
        ret |= n &amp; <span style="color: #88ca9f;">0xF</span>;
    }

    <span style="color: #ff6f9f;">return</span> ret &amp; <span style="color: #88ca9f;">0xFF</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0aa7a23" class="outline-3">
<h3 id="org0aa7a23"><span class="section-number-3">4.2.</span> <code>sigscan</code> function</h3>
<div class="outline-text-3" id="text-4-2">
<p>
And with that, we can make our <code>sigscan</code> function:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdint.h&gt;</span>

<span style="color: #79a8ff;">void</span>* <span style="color: #4ae2ff;">sigscan</span>(<span style="color: #79a8ff;">void</span>* <span style="color: #6ae4b9;">start</span>, <span style="color: #79a8ff;">void</span>* <span style="color: #6ae4b9;">end</span>, <span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">pattern</span>) {
    <span style="color: #989898;">/* </span><span style="color: #989898;">Skip preceding spaces from pattern, if any</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">while</span> (*pattern == <span style="color: #00d3d0;">' '</span>)
        pattern++;

    <span style="color: #989898;">/* </span><span style="color: #989898;">Current position in memory and current position in pattern</span><span style="color: #989898;"> */</span>
    <span style="color: #79a8ff;">uint8_t</span>* <span style="color: #6ae4b9;">mem_ptr</span> = start;
    <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">pat_ptr</span>    = pattern;

    <span style="color: #989898;">/* </span><span style="color: #989898;">Iterate until we reach the end of the memory or the end of the pattern</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">while</span> ((<span style="color: #79a8ff;">void</span>*)mem_ptr &lt; end &amp;&amp; *pat_ptr != <span style="color: #00d3d0;">'\0'</span>) {
        <span style="color: #989898;">/* </span><span style="color: #989898;">Wildcard, always match</span><span style="color: #989898;"> */</span>
        <span style="color: #ff6f9f;">if</span> (*pat_ptr == <span style="color: #00d3d0;">'?'</span>) {
            mem_ptr++;
            pat_ptr++;

            <span style="color: #989898;">/* </span><span style="color: #989898;">Remove trailing spaces after '?'</span>
<span style="color: #989898;">             * </span><span style="color: #44bc44; font-weight: bold;">NOTE:</span><span style="color: #989898;"> I reused this code, but you could use `goto`</span><span style="color: #989898;"> */</span>
            <span style="color: #ff6f9f;">while</span> (*pat_ptr == <span style="color: #00d3d0;">' '</span>)
                pat_ptr++;

            <span style="color: #ff6f9f;">continue</span>;
        }

        <span style="color: #989898;">/* </span><span style="color: #989898;">"E0" -&gt; 224</span><span style="color: #989898;"> */</span>
        <span style="color: #79a8ff;">uint8_t</span> <span style="color: #6ae4b9;">cur_byte</span> = hex_to_byte(pat_ptr);

        <span style="color: #ff6f9f;">if</span> (*mem_ptr == cur_byte) {
            <span style="color: #989898;">/* </span><span style="color: #989898;">Found exact byte match in sequence, go to next byte in memory</span><span style="color: #989898;"> */</span>
            mem_ptr++;

            <span style="color: #989898;">/* </span><span style="color: #989898;">Go to next byte separator in pattern (space)</span><span style="color: #989898;"> */</span>
            <span style="color: #ff6f9f;">while</span> (*pat_ptr != <span style="color: #00d3d0;">' '</span> &amp;&amp; *pat_ptr != <span style="color: #00d3d0;">'\0'</span>)
                pat_ptr++;
        } <span style="color: #ff6f9f;">else</span> {
            <span style="color: #989898;">/* </span><span style="color: #989898;">Byte didn't match, check pattern from the begining on the next</span>
<span style="color: #989898;">             * position in memory</span><span style="color: #989898;"> */</span>
            start++;
            mem_ptr = start;
            pat_ptr = pattern;
        }

        <span style="color: #989898;">/* </span><span style="color: #989898;">Skip trailing spaces</span><span style="color: #989898;"> */</span>
        <span style="color: #ff6f9f;">while</span> (*pat_ptr == <span style="color: #00d3d0;">' '</span>)
            pat_ptr++;
    }

    <span style="color: #989898;">/* </span><span style="color: #989898;">If we reached end of pattern, return the match. Otherwise, NULL</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">return</span> (*pat_ptr == <span style="color: #00d3d0;">'\0'</span>) ? start : <span style="color: #88ca9f;">NULL</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org795547a" class="outline-3">
<h3 id="org795547a"><span class="section-number-3">4.3.</span> Getting the bounds of a loaded module</h3>
<div class="outline-text-3" id="text-4-3">
<p>
On linux, we could use <code>dlopen()</code> to get the start and end addresses of a loaded
module if we were, for example, injecting our own shared object.
</p>

<p>
We have to make our own version of <a href="https://man.cx/dlopen"><code>link_map</code></a> to include <code>link-&gt;phdr[0].p_memsz</code> (to
get the size of the loaded module).
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdint.h&gt;</span>
<span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;link.h&gt;</span>
<span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;dlfcn.h&gt;</span>
<span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdio.h&gt;</span>

<span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">our_link_map</span> {
    <span style="color: #989898;">/* </span><span style="color: #989898;">Base from link.h</span><span style="color: #989898;"> */</span>
    <span style="color: #4ae2ff;">ElfW</span>(Addr) l_addr;
    <span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">l_name</span>;
    <span style="color: #4ae2ff;">ElfW</span>(Dyn) * l_ld;
    <span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">our_link_map</span>* <span style="color: #6ae4b9;">l_next</span>;
    <span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">our_link_map</span>* <span style="color: #6ae4b9;">l_prev</span>;

    <span style="color: #989898;">/* </span><span style="color: #989898;">Added</span><span style="color: #989898;"> */</span>
    <span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">our_link_map</span>* <span style="color: #6ae4b9;">real</span>;
    <span style="color: #79a8ff;">long</span> <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">ns</span>;
    <span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">libname_list</span>* <span style="color: #6ae4b9;">moduleName</span>;
    <span style="color: #4ae2ff;">ElfW</span>(Dyn) *
      info[DT_NUM + DT_VERSIONTAGNUM + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];
    <span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">ElfW</span>(<span style="color: #6ae4b9;">Phdr</span>) * phdr;
};

<span style="color: #79a8ff;">void</span>* <span style="color: #4ae2ff;">find_sig</span>(<span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">module</span>, <span style="color: #ff6f9f;">const</span> <span style="color: #79a8ff;">char</span>* <span style="color: #6ae4b9;">pattern</span>) {
    <span style="color: #ff6f9f;">struct</span> <span style="color: #79a8ff;">our_link_map</span>* <span style="color: #6ae4b9;">link</span> = dlopen(module, RTLD_NOLOAD | RTLD_NOW);
    <span style="color: #ff6f9f;">if</span> (<span style="color: #ff6740; font-weight: bold;">!</span>link) {
        fprintf(stderr, <span style="color: #00d3d0;">"Can't open module \"%s\""</span>, module);
        <span style="color: #ff6f9f;">return</span> <span style="color: #88ca9f;">NULL</span>;
    }

    <span style="color: #989898;">/* </span><span style="color: #cabf00; font-weight: bold;">TODO:</span><span style="color: #989898;"> The size of the binary is not right when passing NULL to</span>
<span style="color: #989898;">     * dlopen()</span><span style="color: #989898;"> */</span>
    <span style="color: #79a8ff;">uint8_t</span>* <span style="color: #6ae4b9;">start</span> = (<span style="color: #79a8ff;">uint8_t</span>*)link-&gt;l_addr;
    <span style="color: #79a8ff;">uint8_t</span>* <span style="color: #6ae4b9;">end</span>   = start + link-&gt;phdr[<span style="color: #88ca9f;">0</span>].p_memsz;

    dlclose(link);

    <span style="color: #ff6f9f;">return</span> sigscan(start, end, pattern);
}
</pre>
</div>

<p>
As far as I know, the windows equivalent of <code>dlopen</code> would be <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya"><code>LoadLibraryA</code></a> and
<a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress"><code>GetProcAddress</code></a>. If you have more information on how this is done on windows,
feel free to <a href="https://github.com/8dcc/8dcc.github.io/pulls">contribute</a>.
</p>

<p>
If we wanted to get the bounds of the main binary, we could use <code>NULL</code> as
parameter to <code>find_sig</code>, so it gets passed to <code>dlopen</code>.
</p>

<blockquote>
<p>
<b>dlopen(3)</b>
</p>

<p>
If filename is NULL, then the returned handle is for the main program. If
filename contains a slash ("/"), then it is interpreted as a (relative or
absolute) pathname.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org5567c6f" class="outline-2">
<h2 id="org5567c6f"><span class="section-number-2">5.</span> Using our <code>find_sig</code> function</h2>
<div class="outline-text-2" id="text-5">
<p>
Now that we have the signature and our function for scanning, we just have to
create a library we can inject into a running process.
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ff6740;">#include</span> <span style="color: #00d3d0;">&lt;stdio.h&gt;</span>

<span style="color: #989898;">/* </span><span style="color: #989898;">Random '?' just to show wilcards</span><span style="color: #989898;"> */</span>
<span style="color: #ff6740;">#define</span> <span style="color: #6ae4b9;">MY_SIG</span> <span style="color: #00d3d0;">"55 48 89 E5 48 83 EC 10 89 ? ? ? ? F8 8B 45 F8 ? ? FC 7F 0C 83"</span>

<span style="color: #989898;">/* </span><span style="color: #989898;">For readability</span><span style="color: #989898;"> */</span>
<span style="color: #ff6f9f;">typedef</span> <span style="color: #79a8ff;">int</span> (*<span style="color: #79a8ff;">func_ptr_t</span>)(<span style="color: #79a8ff;">int</span>, <span style="color: #79a8ff;">int</span>);

<span style="color: #989898;">/* </span><span style="color: #989898;">Entry point when injected</span><span style="color: #989898;"> */</span>
<span style="color: #ff6f9f;">__attribute__</span>((constructor)) <span style="color: #79a8ff;">void</span> <span style="color: #4ae2ff;">load</span>(<span style="color: #79a8ff;">void</span>) {
    puts(<span style="color: #00d3d0;">"Library loaded."</span>);

    <span style="color: #79a8ff;">func_ptr_t</span> <span style="color: #6ae4b9;">found_func</span> = find_sig(<span style="color: #88ca9f;">NULL</span>, MY_SIG);
    <span style="color: #ff6f9f;">if</span> (found_func == <span style="color: #88ca9f;">NULL</span>) {
        fprintf(stderr, <span style="color: #00d3d0;">"my_lib: Could not find function.\n"</span>);
        <span style="color: #ff6f9f;">return</span>;
    }

    printf(<span style="color: #00d3d0;">"my_lib: Found function at %p\n"</span>, found_func);

    <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">a</span> = found_func(<span style="color: #88ca9f;">0x500</span>, <span style="color: #88ca9f;">4</span>);
    printf(<span style="color: #00d3d0;">"my_lib: Function returned %d\n"</span>, a);

    <span style="color: #79a8ff;">int</span> <span style="color: #6ae4b9;">b</span> = found_func(<span style="color: #88ca9f;">0x1000</span>, <span style="color: #88ca9f;">4</span>);
    printf(<span style="color: #00d3d0;">"my_lib: Function returned %d\n"</span>, b);
}

<span style="color: #989898;">/* </span><span style="color: #989898;">Entry point when unloaded</span><span style="color: #989898;"> */</span>
<span style="color: #ff6f9f;">__attribute__</span>((destructor)) <span style="color: #79a8ff;">void</span> <span style="color: #4ae2ff;">unload</span>() {
    <span style="color: #989898;">/* </span><span style="color: #cabf00; font-weight: bold;">TODO:</span><span style="color: #989898;"> Clean up stuff, if needed</span><span style="color: #989898;"> */</span>
    puts(<span style="color: #00d3d0;">"Library unloaded."</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4803303" class="outline-2">
<h2 id="org4803303"><span class="section-number-2">6.</span> Injecting script and final Makefile</h2>
<div class="outline-text-2" id="text-6">
<p>
We can inject our library into the binary the <a href="https://www.sourceware.org/gdb/">GNU Debugger</a>.
</p>

<p>
First, we attach to the PID of our target process (<code>example.out</code>), and, after
locating <code>dlopen</code> and <code>dlerror</code>, we call <code>dlopen</code> with two arguments: the path of our
library and the number 2, which corresponds to <code>RTLD_NOW</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #6ae4b9;">pid</span>=$(<span style="color: #feacd0;">pidof "example.out"</span>)
<span style="color: #6ae4b9;">libpath</span>=$(<span style="color: #feacd0;">realpath "my_lib.so"</span>)

<span style="color: #ff6f9f;">if</span> [ <span style="color: #00d3d0;">"$pid"</span> == <span style="color: #00d3d0;">""</span> ]; <span style="color: #ff6f9f;">then</span>
   <span style="color: #feacd0;">echo</span> <span style="color: #00d3d0;">"inject.sh: process not running."</span>
   <span style="color: #ff6f9f;">exit</span> <span style="color: #88ca9f;">1</span>
<span style="color: #ff6f9f;">fi</span>

sudo gdb -n -q -batch                                  <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"attach $pid"</span>                                  <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"set \$dlopen = (void* (*)(char*, int))dlopen"</span> <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"set \$dlerror = (char* (*)(void))dlerror"</span>     <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"call \$dlopen(\"$libpath\", 2)"</span>               <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"call \$dlerror()"</span>                             <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"detach"</span>                                       <span style="color: #00d3d0;">\</span>
    -ex <span style="color: #00d3d0;">"quit"</span>
</pre>
</div>

<p>
This is the final Makefile for compiling the example app, the library and for
injecting:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #6ae4b9;">CC</span>=gcc
<span style="color: #6ae4b9;">CFLAGS</span>=-Wall -Wextra -O0 -fPIC
<span style="color: #6ae4b9;">LDFLAGS</span>=

<span style="color: #4ae2ff;">.PHONY</span>: all inject

<span style="color: #4ae2ff;">all</span>: example.out my_lib.so

<span style="color: #4ae2ff;">example.out</span>: example.c
    $(<span style="color: #6ae4b9;">CC</span>) $(<span style="color: #6ae4b9;">CFLAGS</span>) -o <span style="color: #4ae2ff;">$</span><span style="color: #88ca9f;">@</span> $<span style="color: #88ca9f;">&lt;</span> $(<span style="color: #6ae4b9;">LDFLAGS</span>)

<span style="color: #4ae2ff;">my_lib.so</span>: my_lib.c
    $(<span style="color: #6ae4b9;">CC</span>) $(<span style="color: #6ae4b9;">CFLAGS</span>) -shared -o <span style="color: #4ae2ff;">$</span><span style="color: #88ca9f;">@</span> $<span style="color: #88ca9f;">&lt;</span> $(<span style="color: #6ae4b9;">LDFLAGS</span>)

<span style="color: #989898;"># </span><span style="color: #44bc44; font-weight: bold;">NOTE:</span><span style="color: #989898;"> Make sure example.out is running</span>
<span style="color: #4ae2ff;">inject</span>: my_lib.so
    bash ./inject.sh
</pre>
</div>
</div>
</div>
</div>
</body>
</html>