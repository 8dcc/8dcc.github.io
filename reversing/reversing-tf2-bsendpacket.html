<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reversing TF2's bSendPacket</title>
<meta name="author" content="8dcc" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="icon" type="image/x-icon" href="../img/favicon.png">
<link rel="stylesheet" type="text/css" href="../css/main.css">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Reversing TF2's bSendPacket</h1>
<p>
<a href="../index.html">Index</a> | <a href="index.html">Up</a>
</p>

<hr />

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6c6b611">1. Introduction</a></li>
<li><a href="#org66f41f0">2. The problem</a></li>
<li><a href="#orgb22f5b6">3. The old solution</a></li>
<li><a href="#orgd3cdb3a">4. The new problem</a></li>
<li><a href="#org9ddf1b9">5. Finding the right offset in the stack</a></li>
<li><a href="#orge1d45a8">6. Getting the value with an assembly proxy</a></li>
<li><a href="#org3180116">7. Getting the value using GCC's built-ins</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6c6b611" class="outline-2">
<h2 id="org6c6b611"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Team Fortress 2 (TF2) is a 2007 multiplayer first-person shooter game developed
and published by Valve Corporation (<a href="https://en.wikipedia.org/wiki/Team_Fortress_2">Wikipedia</a>).
</p>

<p>
On <a href="https://github.com/8dcc/tf2-cheat/commit/0daa5bb7b03abf0ae8b150312f0147eb7ef5a148">Aug 6, 2023</a>, I started working on a TF2 cheat for GNU/Linux, and in over 600
commits, I was pretty happy with the result.
</p>

<p>
However, on April 19, 2024 (just a few days before writing this), Valve released
a 64-bit update. For windows, this just meant an extra architecture, but on
GNU/Linux, they entirely removed the 32-bit binaries. I decided to archive the
repository and continue developing the cheat privately.
</p>

<p>
One of the main reasons for this decision was that I wanted to avoid essentially
releasing fixes for the cheat, that would get used by people who are just
interested in copy-pasting a working cheat and selling it, or making <a href="https://www.theverge.com/2022/5/27/23144061/valve-team-fortress-2-bot-problem-savetf2-spam">bots</a>. As I
explained in the repository's README, I made this project because I enjoyed
reversing the game in a platform with not much reference, and I enjoyed the low
level aspect of essentially having to do all the dirty work of reversing the
game and making everything work.
</p>

<p>
It is not fair to say that I was the only one involved, and obviously some
people did help me greatly. I just want to quickly mention <a href="https://github.com/Lak3">Lak3</a> for his time and
help, and <a href="https://github.com/nepcat">nepcat</a> for his helpful PRs, and his interest in the project.
</p>

<p>
Now that my little goodbye letter to the project is finished, we can get to
finding <code>bSendPacket</code>.
</p>
</div>
</div>

<div id="outline-container-org66f41f0" class="outline-2">
<h2 id="org66f41f0"><span class="section-number-2">2.</span> The problem</h2>
<div class="outline-text-2" id="text-2">
<p>
First, in case the reader is unfamiliar with game hacking in the source engine,
I need to briefly explain what <code>bSendPacket</code> is used for.
</p>

<p>
In the source engine, we run a lot of our hacks from the <code>CreateMove</code> hook (for
more information about hooking in general, see my <a href="../programming/detour-hooking.html">Detour Hooking</a>
entry). However, there is not just one <code>CreateMove</code>, and some people choose to
hook one over the other. In my case, I have always hooked
<code>ClientModeShared::CreateMove</code>.
</p>

<p>
Let's have a look at where this is called by looking at the <a href="https://github.com/OthmanAba/TeamFortress2">leaked TF2 source</a>.
</p>

<ol class="org-ol">
<li>Our <code>ClientModeShared::CreateMove</code> function is defined in
<a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/game/client/clientmode_shared.cpp#L417"><code>clientmode_shared.cpp</code></a>. As you can see, it calls another <code>CreateMove</code>
function, but we don't care about that one.</li>
<li>This <code>ClientModeShared::CreateMove</code> function is called from <code>CInput::CreateMove</code>,
defined in <a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/game/client/in_main.cpp#L1111"><code>in_main.cpp</code></a>. You can see it calls it from a <code>g_pClientMode</code> global
pointer.</li>
<li>This <code>CInput::CreateMove</code> function is called from <code>CHLClient::CreateMove</code>,
defined in <a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/game/client/cdll_client_int.cpp#L1448"><code>cdll_client_int.cpp</code></a>.</li>
<li>Finally, this <code>CHLClient::CreateMove</code> function is called from <code>CL_Move</code>, defined
in <a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/engine/cl_main.cpp#L2119"><code>cl_main.cpp</code></a>.</li>
</ol>

<p>
So, in order, the calls would be the following:
</p>

<pre class="example" id="org25e6629">
CL_Move()  -&gt;  CHLClient::CreateMove()  -&gt;  CInput::CreateMove()  -&gt;  ClientModeShared::CreateMove()
</pre>

<p>
Okay, but why is this important? Let's have a look at this last function,
<code>CL_Move</code>. It defines a <a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/engine/cl_main.cpp#L2130">local variable</a> called <code>bSendPacket</code>, which will later
<a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/engine/cl_main.cpp#L2178-L2188">decides</a> if the current command should be sent or, on the other hand, choked.
</p>

<p>
Being able to control which packets are sent and which ones aren't is extremely
useful for us, so we need to find a way of changing the value of this local
variable, ideally from <code>ClientModeShared::CreateMove</code>.
</p>
</div>
</div>

<div id="outline-container-orgb22f5b6" class="outline-2">
<h2 id="orgb22f5b6"><span class="section-number-2">3.</span> The old solution</h2>
<div class="outline-text-2" id="text-3">
<p>
When I started developing my cheat for the 32-bit game, I came across an
(almost) valid solution.
</p>

<p>
Since <code>CL_Move</code> only sets <code>bSendPacket</code> to true on <a href="https://github.com/OthmanAba/TeamFortress2/blob/1b81dded673d49adebf4d0958e52236ecc28a956/tf2_src/engine/cl_main.cpp#L2130">once place</a>, we could just
overwrite this constant in memory, so that it gets initialized to true only
whenever we want.
</p>

<p>
Let's look at the <b>old 32-bit binary</b> from IDA. If we open <code>engine.so</code>, where
<code>CL_Move</code> is located, we can search for the function by looking for the strings
that it uses, and jumping to their xrefs. Then, we can hit the almighty <code>F5</code> key
to decompile the function.
</p>


<div id="org9c45f4b" class="figure">
<p><img src="../img/bsendpacket1.png" alt="bsendpacket1.png" />
</p>
</div>

<p>
I renamed the variables on the decompiler window (right split), but it should be
pretty clear what does what by comparing it with the source. As we can see by
the bytes on the left (<i>Options &gt; General &gt; Number of opcode bytes</i>), it's setting
<code>esi</code> (<code>bSendPacket</code>) to true by moving the literal value <code>0x00000001</code> (note that this
is <a href="https://en.wikipedia.org/wiki/Endianness">little endian</a>).
</p>

<p>
We could get a pointer to where those <code>01 00 00 00</code> bytes are in memory, and then
cast it to a <code>bool*</code>. To do this, we could, for example, look for a signature in
the game's memory (see my <a href="../programming/signature-scanning.html">Signature Scanning in C</a> entry). Once we have this
pointer, we could use it for controlling the packet flow, right?  Not really.
</p>

<p>
This approach has a couple of flaws. The first one is that we can't force it to
true, just to false. If we leave it as it was (true), the game might set it to
false later in the function. This is not a problem in our case, but it's
something to keep in mind.
</p>

<p>
Another problem is that, if we look at the position of the value we are changing
and the position where <code>CL_Move</code> calls <code>CHLClient::CreateMove</code>, we can see that we
are overwriting the bytes of an instruction that <b>has already been executed in
this tick</b>. Therefore, our change will affect the next tick. This is a problem
that I didn't realize until the game updated to 64-bits, and it has probably
caused me a lot of unusual trouble before.
</p>
</div>
</div>

<div id="outline-container-orgd3cdb3a" class="outline-2">
<h2 id="orgd3cdb3a"><span class="section-number-2">4.</span> The new problem</h2>
<div class="outline-text-2" id="text-4">
<p>
TODO
</p>
</div>
</div>

<div id="outline-container-org9ddf1b9" class="outline-2">
<h2 id="org9ddf1b9"><span class="section-number-2">5.</span> Finding the right offset in the stack</h2>
<div class="outline-text-2" id="text-5">
<p>
TODO
</p>
</div>
</div>

<div id="outline-container-orge1d45a8" class="outline-2">
<h2 id="orge1d45a8"><span class="section-number-2">6.</span> Getting the value with an assembly proxy</h2>
<div class="outline-text-2" id="text-6">
<p>
TODO
</p>
</div>
</div>

<div id="outline-container-org3180116" class="outline-2">
<h2 id="org3180116"><span class="section-number-2">7.</span> Getting the value using GCC's built-ins</h2>
<div class="outline-text-2" id="text-7">
<p>
TODO
</p>
</div>
</div>
</div>
</body>
</html>
